version: '3.8'

services:
  # ============================================================================
  # PostgreSQL Database
  # ============================================================================
  postgres:
    image: postgres:15-alpine
    container_name: guessly-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${DB_DATABASE:-guessly}
      POSTGRES_USER: ${DB_USERNAME:-postgres}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-postgres}
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - '${DB_PORT:-5432}:5432'
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - guessly-network
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U ${DB_USERNAME:-postgres}']
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================================================
  # Redis (Cache & Queues)
  # ============================================================================
  redis:
    image: redis:7-alpine
    container_name: guessly-redis
    restart: unless-stopped
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD:-}
    ports:
      - '${REDIS_PORT:-6379}:6379'
    volumes:
      - redis_data:/data
    networks:
      - guessly-network
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 10s
      timeout: 3s
      retries: 5

  # ============================================================================
  # NestJS Backend API
  # ============================================================================
  api:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    container_name: guessly-api
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      # Application
      NODE_ENV: ${NODE_ENV:-development}
      PORT: ${PORT:-3000}
      API_PREFIX: ${API_PREFIX:-api/v1}

      # Database
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USERNAME: ${DB_USERNAME:-postgres}
      DB_PASSWORD: ${DB_PASSWORD:-postgres}
      DB_DATABASE: ${DB_DATABASE:-guessly}
      DB_SYNCHRONIZE: ${DB_SYNCHRONIZE:-false}
      DB_LOGGING: ${DB_LOGGING:-false}

      # Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-}
      REDIS_DB: ${REDIS_DB:-0}

      # JWT
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRATION: ${JWT_EXPIRATION:-7d}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET}
      JWT_REFRESH_EXPIRATION: ${JWT_REFRESH_EXPIRATION:-30d}

      # Blockchain
      BLOCKCHAIN_NETWORK: ${BLOCKCHAIN_NETWORK:-baseSepolia}
      BLOCKCHAIN_RPC_URL: ${BLOCKCHAIN_RPC_URL}
      BLOCKCHAIN_CHAIN_ID: ${BLOCKCHAIN_CHAIN_ID:-84532}
      BLOCKCHAIN_PROVIDER_PRIVATE_KEY: ${BLOCKCHAIN_PROVIDER_PRIVATE_KEY}

      # Smart Contracts
      CONTRACT_USDC: ${CONTRACT_USDC}
      CONTRACT_FEE_COLLECTOR: ${CONTRACT_FEE_COLLECTOR}
      CONTRACT_CREATOR_SHARE_FACTORY: ${CONTRACT_CREATOR_SHARE_FACTORY}
      CONTRACT_OPINION_MARKET: ${CONTRACT_OPINION_MARKET}

      # Twitter API
      TWITTER_CLIENT_ID: ${TWITTER_CLIENT_ID}
      TWITTER_CLIENT_SECRET: ${TWITTER_CLIENT_SECRET}
      TWITTER_CALLBACK_URL: ${TWITTER_CALLBACK_URL}
      TWITTER_BEARER_TOKEN: ${TWITTER_BEARER_TOKEN}

      # CORS
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS:-http://localhost:3000,http://localhost:3001}
      CORS_CREDENTIALS: ${CORS_CREDENTIALS:-true}
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:3001}
      ADMIN_DASHBOARD_URL: ${ADMIN_DASHBOARD_URL}

      # Rate Limiting
      THROTTLE_TTL: ${THROTTLE_TTL:-60}
      THROTTLE_LIMIT: ${THROTTLE_LIMIT:-100}
      RATE_LIMIT_WHITELIST_IPS: ${RATE_LIMIT_WHITELIST_IPS:-127.0.0.1,::1}

      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-debug}
      LOG_TO_CONSOLE: ${LOG_TO_CONSOLE:-true}
      LOG_TO_FILE: ${LOG_TO_FILE:-false}
      LOG_QUERIES: ${LOG_QUERIES:-false}

      # Monitoring
      SENTRY_DSN: ${SENTRY_DSN}
      SENTRY_ENABLED: ${SENTRY_ENABLED:-false}
      SENTRY_TRACES_SAMPLE_RATE: ${SENTRY_TRACES_SAMPLE_RATE:-0.1}
      APP_VERSION: ${APP_VERSION:-0.1.0}

      # Performance
      SLOW_ENDPOINT_THRESHOLD_MS: ${SLOW_ENDPOINT_THRESHOLD_MS:-1000}

      # Swagger
      SWAGGER_ENABLED: ${SWAGGER_ENABLED:-true}

      # Admin
      ADMIN_USERNAME: ${ADMIN_USERNAME:-admin}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD}

      # Notifications
      SENDGRID_API_KEY: ${SENDGRID_API_KEY}
      SENDGRID_FROM_EMAIL: ${SENDGRID_FROM_EMAIL}
      FCM_SERVER_KEY: ${FCM_SERVER_KEY}
      ALERT_WEBHOOK_URL: ${ALERT_WEBHOOK_URL}
    ports:
      - '${PORT:-3000}:3000'
    volumes:
      - ./uploads:/app/uploads
      - ./logs:/app/logs
    networks:
      - guessly-network
    healthcheck:
      test: ['CMD', 'node', '-e', "require('http').get('http://localhost:3000/api/v1/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 40s

  # ============================================================================
  # PgAdmin (Database UI - Optional)
  # ============================================================================
  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: guessly-pgadmin
    restart: unless-stopped
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@guesslyfe.com}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD:-admin}
      PGADMIN_CONFIG_SERVER_MODE: 'False'
      PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED: 'False'
    ports:
      - '${PGADMIN_PORT:-5050}:80'
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    networks:
      - guessly-network
    depends_on:
      - postgres
    profiles:
      - tools  # Only start when using --profile tools

# ==============================================================================
# Networks
# ==============================================================================
networks:
  guessly-network:
    driver: bridge
    name: guessly-network

# ==============================================================================
# Volumes
# ==============================================================================
volumes:
  postgres_data:
    driver: local
    name: guessly-postgres-data
  redis_data:
    driver: local
    name: guessly-redis-data
  pgadmin_data:
    driver: local
    name: guessly-pgadmin-data
